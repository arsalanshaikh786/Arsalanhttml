<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plumbing Services - BeSure</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    #chatBox, #trackBox { display: none; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Header -->
  <header class="bg-blue-700 text-white py-6 shadow">
    <div class="max-w-7xl mx-auto px-4">
      <h1 class="text-3xl font-bold">ğŸš° Plumbing Services</h1>
      <p class="text-sm mt-1">Fast â€¢ Reliable â€¢ Affordable</p>
    </div>
  </header>

  <!-- Services -->
  <section class="max-w-6xl mx-auto px-4 py-10">
    <h2 class="text-2xl font-bold mb-6 text-center">ğŸ”§ Our Services</h2>
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      <div class="bg-white p-5 rounded-xl shadow">ğŸš¿ <strong>Tap Repair:</strong> Leaking or broken tap fixes.</div>
      <div class="bg-white p-5 rounded-xl shadow">ğŸš½ <strong>Toilet Fix:</strong> Flush, leakage, and blockage solutions.</div>
      <div class="bg-white p-5 rounded-xl shadow">ğŸ§¼ <strong>Drain Cleaning:</strong> Unclog sinks and pipelines.</div>
      <div class="bg-white p-5 rounded-xl shadow">ğŸ”¥ <strong>Geyser Install:</strong> Electric & gas geyser setup.</div>
      <div class="bg-white p-5 rounded-xl shadow">ğŸ§° <strong>Leak Repairs:</strong> Pipe leakage and replacements.</div>
      <div class="bg-white p-5 rounded-xl shadow">ğŸ  <strong>Bathroom Setup:</strong> Full plumbing fitting for bathrooms.</div>
    </div>
  </section>

  <!-- Booking -->
  <section class="bg-white py-10 px-4">
    <div class="max-w-2xl mx-auto">
      <h2 class="text-2xl font-bold mb-4 text-center">ğŸ“… Book a Plumber</h2>
      <form id="bookingForm" class="space-y-4 bg-gray-50 p-6 rounded-xl shadow">
        <input type="text" name="name" placeholder="Your Name" required class="w-full px-4 py-2 border rounded-lg" id="nameField">
        <input type="tel" name="phone" placeholder="Phone Number" required class="w-full px-4 py-2 border rounded-lg">
        <input type="email" name="email" placeholder="Email Address" required class="w-full px-4 py-2 border rounded-lg" id="emailField">
        <textarea name="address" rows="2" placeholder="Full Address" required class="w-full px-4 py-2 border rounded-lg"></textarea>
        <select name="service" required class="w-full px-4 py-2 border rounded-lg">
          <option value="">Select Service</option>
          <option>Tap Repair</option>
          <option>Toilet Fix</option>
          <option>Drain Cleaning</option>
          <option>Geyser Installation</option>
          <option>Leakage Repair</option>
          <option>Full Bathroom Fitting</option>
        </select>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Book Now</button>
      </form>
    </div>
  </section>

  <!-- Floating Buttons -->
  <div class="fixed bottom-6 right-6 flex flex-col gap-3 z-50">
    <button onclick="toggleChat()" class="bg-blue-600 text-white p-4 rounded-full shadow-lg">ğŸ’¬</button>
    <button onclick="toggleTrack()" class="bg-green-600 text-white p-4 rounded-full shadow-lg">ğŸ“©</button>
  </div>

  <!-- Chat Box -->
  <div id="chatBox" class="fixed bottom-24 right-4 w-80 bg-white border rounded-xl shadow-xl z-50 overflow-hidden">
    <div class="bg-blue-700 text-white p-4 flex justify-between items-center">
      <span class="font-semibold">Plumber Chat</span>
      <button onclick="toggleChat()">âœ–</button>
    </div>
    <div id="chatMessages" class="h-64 overflow-y-auto p-3 bg-gray-50 space-y-2 text-sm"></div>
    <div class="flex border-t p-2">
      <input id="chatInput" type="text" placeholder="Type a message..." class="flex-1 px-3 py-2 border rounded-l-md">
      <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 rounded-r-md">Send</button>
    </div>
  </div>

  <!-- Track Box -->
  <div id="trackBox" class="fixed bottom-24 right-24 w-96 bg-white border rounded-xl shadow-xl z-50 p-4">
    <div class="flex justify-between items-center mb-2">
      <h3 class="text-lg font-semibold text-blue-700">ğŸ“¦ Track Booking</h3>
      <button onclick="toggleTrack()">âœ–</button>
    </div>
    <input type="email" id="trackEmail" placeholder="Enter your email" class="w-full px-3 py-2 border rounded mb-2"/>
    <button onclick="trackBooking()" class="w-full bg-green-600 text-white py-2 rounded mb-4">Track</button>
    <div id="trackResults" class="text-sm max-h-64 overflow-y-auto space-y-2"></div>
  </div>

  <!-- Footer -->
  <footer class="bg-blue-700 text-white py-4 text-center mt-10">
    &copy; 2025 BeSure Multi-Service App | Plumbing Services
  </footer>

  <!-- Firebase & Telegram Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, getDocs, doc, serverTimestamp, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD-example-KEY",
      authDomain: "multi-service-app-77dd8.firebaseapp.com",
      projectId: "multi-service-app-77dd8",
      storageBucket: "multi-service-app-77dd8.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:yourappid"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const botToken = "7458392373:AAFfQ-C-AZLoQboxuA5fRZEuRoT8ShkRVNE";
    const chatId = "5547663296";

    // Autofill
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById("emailField").value = localStorage.getItem("email") || "";
      document.getElementById("nameField").value = localStorage.getItem("name") || "";
    });

    // Booking Handler
    document.getElementById("bookingForm").addEventListener("submit", async e => {
      e.preventDefault();
      const form = e.target;
      const data = {
        name: form.name.value,
        phone: form.phone.value,
        email: form.email.value,
        address: form.address.value,
        service: form.service.value,
        timestamp: serverTimestamp(),
        status: "Pending"
      };
      localStorage.setItem("email", data.email);
      localStorage.setItem("name", data.name);
      try {
        await addDoc(collection(db, "plumbing_bookings"), data);
        await fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(`ğŸ“¬ New Booking:\nğŸ‘¤ ${data.name}\nğŸ“ ${data.phone}\nğŸ  ${data.address}\nğŸ› ï¸ ${data.service}`)}`);
        alert("Booking successful!");
        form.reset();
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // Chat
    window.sendMessage = async () => {
      const msg = document.getElementById("chatInput").value.trim();
      const name = localStorage.getItem("name") || "Customer";
      if (!msg) return;
      await addDoc(collection(db, "plumber_chat"), { sender: name, text: msg, timestamp: serverTimestamp() });
      await fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent("ğŸ’¬ " + name + ": " + msg)}`);
      document.getElementById("chatInput").value = "";
    };

    const chatBox = document.getElementById("chatMessages");
    const chatQuery = query(collection(db, "plumber_chat"), orderBy("timestamp"));
    onSnapshot(chatQuery, snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const me = d.sender === (localStorage.getItem("name") || "Customer");
        chatBox.innerHTML += `<div class="${me ? 'text-right' : 'text-left'}"><span class="inline-block px-3 py-1 rounded-xl ${me ? 'bg-blue-100' : 'bg-gray-200'}">${d.text}</span></div>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Toggle UI
    window.toggleChat = () => {
      const c = document.getElementById("chatBox");
      c.style.display = c.style.display === "none" ? "block" : "none";
    };
    window.toggleTrack = () => {
      const t = document.getElementById("trackBox");
      t.style.display = t.style.display === "none" ? "block" : "none";
    };

    // Track Booking
    window.trackBooking = async () => {
      const email = document.getElementById("trackEmail").value;
      const resultBox = document.getElementById("trackResults");
      resultBox.innerHTML = "ğŸ”„ Loading...";
      const q = query(collection(db, "plumbing_bookings"), where("email", "==", email));
      const snap = await getDocs(q);
      if (snap.empty) {
        resultBox.innerHTML = "âŒ No bookings found.";
        return;
      }
      resultBox.innerHTML = "";
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const ts = d.timestamp?.toDate();
        const now = Date.now();
        const allowCancel = ts && (now - ts.getTime()) < 600000;
        resultBox.innerHTML += `
          <div class="border p-2 rounded bg-gray-50">
            <strong>${d.service}</strong><br/>
            ğŸ“ ${d.address}<br/>
            ğŸ•’ ${ts}<br/>
            ğŸŸ¡ Status: <b>${d.status || "Pending"}</b><br/>
            ${allowCancel ? `<button onclick="cancelBooking('${docSnap.id}')" class="mt-2 bg-red-600 text-white px-3 py-1 rounded">Cancel</button>` : ""}
          </div>`;
      });
    };

    // Cancel Booking
    window.cancelBooking = async (id) => {
      if (confirm("Are you sure you want to cancel this booking?")) {
        await deleteDoc(doc(db, "plumbing_bookings", id));
        alert("Booking cancelled.");
        trackBooking();
      }
    };
  </script>
</body>
</html>
